# Data Model: Authentication + User Profiling

**Feature**: 006-user-auth-profiling
**Date**: 2025-12-17
**Database**: PostgreSQL (shared with existing RAG system)

---

## Entity Relationship Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                           user                                   │
├─────────────────────────────────────────────────────────────────┤
│ id              : TEXT PRIMARY KEY                              │
│ name            : TEXT NOT NULL                                 │
│ email           : TEXT NOT NULL UNIQUE                          │
│ email_verified  : BOOLEAN DEFAULT FALSE                         │
│ image           : TEXT                                          │
│ created_at      : TIMESTAMP DEFAULT NOW()                       │
│ updated_at      : TIMESTAMP DEFAULT NOW()                       │
│ ─────────────── PROFILE FIELDS (additionalFields) ────────────  │
│ programming_level      : TEXT NOT NULL                          │
│ technologies           : TEXT NOT NULL (JSON array as string)   │
│ ai_robotics_experience : BOOLEAN NOT NULL                       │
│ hardware_access        : TEXT NOT NULL                          │
│ devices_owned          : TEXT (JSON array as string, optional)  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                          session                                 │
├─────────────────────────────────────────────────────────────────┤
│ id              : TEXT PRIMARY KEY                              │
│ user_id         : TEXT NOT NULL → user.id                       │
│ token           : TEXT NOT NULL UNIQUE                          │
│ expires_at      : TIMESTAMP NOT NULL                            │
│ ip_address      : TEXT                                          │
│ user_agent      : TEXT                                          │
│ created_at      : TIMESTAMP DEFAULT NOW()                       │
│ updated_at      : TIMESTAMP DEFAULT NOW()                       │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        verification                              │
├─────────────────────────────────────────────────────────────────┤
│ id              : TEXT PRIMARY KEY                              │
│ identifier      : TEXT NOT NULL (email)                         │
│ value           : TEXT NOT NULL (token)                         │
│ expires_at      : TIMESTAMP NOT NULL                            │
│ created_at      : TIMESTAMP DEFAULT NOW()                       │
│ updated_at      : TIMESTAMP DEFAULT NOW()                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## Entity Definitions

### User Entity

The `user` table stores authentication credentials and profile information. Better Auth manages the core fields; profile fields are added via `additionalFields`.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | TEXT | PRIMARY KEY | UUID generated by Better Auth |
| `name` | TEXT | NOT NULL | User's display name |
| `email` | TEXT | NOT NULL, UNIQUE | Email address for authentication |
| `email_verified` | BOOLEAN | DEFAULT FALSE | Email verification status |
| `image` | TEXT | NULLABLE | Profile image URL |
| `created_at` | TIMESTAMP | DEFAULT NOW() | Account creation timestamp |
| `updated_at` | TIMESTAMP | DEFAULT NOW() | Last update timestamp |
| `programming_level` | TEXT | NOT NULL | Enum: "beginner", "intermediate", "advanced" |
| `technologies` | TEXT | NOT NULL | JSON array: ["Python", "JS", "ROS2", "AI/ML", "Web", "Other"] |
| `ai_robotics_experience` | BOOLEAN | NOT NULL | Has AI/Robotics experience |
| `hardware_access` | TEXT | NOT NULL | Enum: "none", "simulator_only", "real_robots" |
| `devices_owned` | TEXT | NULLABLE | JSON array: ["Jetson", "Raspberry Pi", "Arduino", "GPU", "Other"] |

### Session Entity

The `session` table manages active user sessions. Fully managed by Better Auth.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | TEXT | PRIMARY KEY | Session UUID |
| `user_id` | TEXT | NOT NULL, FK → user.id | Associated user |
| `token` | TEXT | NOT NULL, UNIQUE | Session token (hashed) |
| `expires_at` | TIMESTAMP | NOT NULL | Session expiration time |
| `ip_address` | TEXT | NULLABLE | Client IP address |
| `user_agent` | TEXT | NULLABLE | Client user agent string |
| `created_at` | TIMESTAMP | DEFAULT NOW() | Session creation time |
| `updated_at` | TIMESTAMP | DEFAULT NOW() | Last activity time |

### Verification Entity

The `verification` table stores email verification tokens. Managed by Better Auth.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | TEXT | PRIMARY KEY | Verification UUID |
| `identifier` | TEXT | NOT NULL | Email being verified |
| `value` | TEXT | NOT NULL | Verification token |
| `expires_at` | TIMESTAMP | NOT NULL | Token expiration |
| `created_at` | TIMESTAMP | DEFAULT NOW() | Token creation time |
| `updated_at` | TIMESTAMP | DEFAULT NOW() | Last update time |

---

## Enum Definitions

### ProgrammingLevel

```typescript
type ProgrammingLevel = "beginner" | "intermediate" | "advanced";
```

| Value | Description |
|-------|-------------|
| `beginner` | Little to no programming experience |
| `intermediate` | Comfortable with programming basics |
| `advanced` | Experienced developer |

### HardwareAccess

```typescript
type HardwareAccess = "none" | "simulator_only" | "real_robots";
```

| Value | Description |
|-------|-------------|
| `none` | No hardware or simulator access |
| `simulator_only` | Access to simulation environments only |
| `real_robots` | Access to physical robot hardware |

### TechnologyOption

```typescript
type TechnologyOption = "Python" | "JS" | "ROS2" | "AI/ML" | "Web" | "Other";
```

Stored as JSON array string in database.

### DeviceOption

```typescript
type DeviceOption = "Jetson" | "Raspberry Pi" | "Arduino" | "GPU" | "Other";
```

Stored as JSON array string in database. Field is optional.

---

## Validation Rules

### User Validation

| Field | Validation |
|-------|------------|
| `email` | Valid email format, unique |
| `name` | Non-empty string, max 255 chars |
| `programming_level` | Must be valid enum value |
| `technologies` | Valid JSON array, at least one selection |
| `ai_robotics_experience` | Boolean |
| `hardware_access` | Must be valid enum value |
| `devices_owned` | Valid JSON array or null |

### Password Validation (Better Auth)

- Minimum length: 8 characters
- Maximum length: 128 characters
- Hashed using Argon2

### Session Validation

- Token must be unique
- Expires in 7 days (configurable)
- Auto-refreshed on activity

---

## State Transitions

### User Account States

```
                    ┌──────────────────┐
                    │                  │
   signUp()         │    CREATED       │
   ─────────────────►   (unverified)   │
                    │                  │
                    └────────┬─────────┘
                             │
                    verifyEmail()
                             │
                             ▼
                    ┌──────────────────┐
                    │                  │
                    │    VERIFIED      │
                    │    (active)      │
                    │                  │
                    └──────────────────┘
```

### Session States

```
                    ┌──────────────────┐
                    │                  │
   signIn()         │     ACTIVE       │◄────────┐
   ─────────────────►                  │         │
                    └────────┬─────────┘         │
                             │                   │
              ┌──────────────┼──────────────┐    │
              │              │              │    │
         signOut()      expires_at     activity  │
              │         reached            │     │
              │              │              │    │
              ▼              ▼              └────┘
     ┌────────────┐  ┌────────────┐       refresh
     │  ENDED     │  │  EXPIRED   │
     │ (deleted)  │  │ (deleted)  │
     └────────────┘  └────────────┘
```

---

## Indexes

### Recommended Indexes

```sql
-- User lookups
CREATE UNIQUE INDEX idx_user_email ON "user"(email);

-- Session lookups
CREATE INDEX idx_session_user_id ON session(user_id);
CREATE INDEX idx_session_expires_at ON session(expires_at);
CREATE UNIQUE INDEX idx_session_token ON session(token);

-- Verification lookups
CREATE INDEX idx_verification_identifier ON verification(identifier);
CREATE INDEX idx_verification_expires_at ON verification(expires_at);
```

Note: Better Auth CLI auto-creates these indexes during migration.

---

## Migration Strategy

### Initial Setup

1. Run Better Auth CLI to generate schema:
   ```bash
   npx @better-auth/cli generate
   ```

2. Review generated SQL migrations

3. Apply migrations:
   ```bash
   npx @better-auth/cli migrate
   ```

### Profile Fields Migration

The `additionalFields` are included in the initial schema generation when configured in `auth.ts`.

---

## Data Access Patterns

### Frontend (via Better Auth Client)

```typescript
// Get current user with profile
const { data: session } = authClient.useSession();
const user = session?.user;
// user.programmingLevel, user.technologies, etc.
```

### Backend (FastAPI - Direct DB Access)

```python
# Read user profile from shared database
from sqlalchemy import select
from sqlalchemy.orm import Session

def get_user_profile(db: Session, user_id: str) -> UserProfile:
    result = db.execute(
        select(User).where(User.id == user_id)
    ).scalar_one_or_none()

    if not result:
        raise HTTPException(status_code=401, detail="User not found")

    return UserProfile(
        programming_level=result.programming_level,
        technologies=json.loads(result.technologies),
        hardware_access=result.hardware_access
    )
```

---

## Profile Completeness Check

A user profile is considered complete when:

```typescript
function isProfileComplete(user: User): boolean {
  return (
    user.programmingLevel !== null &&
    user.technologies !== null &&
    user.technologies.length > 0 &&
    user.aiRoboticsExperience !== null &&
    user.hardwareAccess !== null
  );
}
```

Incomplete profiles block chatbot access (FR-017).
