# Data Model: RAG Retrieval & Pipeline Validation

**Feature**: 002-rag-retrieval
**Date**: 2025-12-15

## Overview

This document defines the data structures for the retrieval functionality. All structures are implemented as Python dataclasses and integrate with the existing `DocusaurusEmbeddingPipeline` class.

## Entities

### 1. QueryResult

Represents a single retrieval result from the vector database.

```python
@dataclass
class QueryResult:
    score: float              # Similarity score (0.0 to 1.0)
    content: str              # Chunk text content
    url: str                  # Source page URL
    position: int             # Chunk position in source document
    created_at: float         # Timestamp when chunk was ingested
```

**Source**: Returned from Qdrant search results
**Validation Rules**:
- `score` must be between 0.0 and 1.0
- `content` must be non-empty string
- `url` must be valid URL format
- `position` must be >= 0

---

### 2. RetrievalResponse

Represents the complete response from a search query.

```python
@dataclass
class RetrievalResponse:
    query: str                    # Original query text
    results: List[QueryResult]    # Ordered list of results (highest score first)
    total: int                    # Number of results returned
    time_ms: int                  # Query execution time in milliseconds
    collection: str               # Collection that was searched
```

**Source**: Generated by the `search()` method
**Computed Fields**:
- `total` = `len(results)`

---

### 3. SearchFilter

Optional constraints to narrow search results.

```python
@dataclass
class SearchFilter:
    url: Optional[str] = None      # Filter by exact URL match
    url_contains: Optional[str] = None  # Filter by URL substring
    top_k: int = 5                 # Maximum results to return
```

**Default Values**:
- `url`: None (no URL filtering)
- `url_contains`: None (no substring filtering)
- `top_k`: 5 (return 5 results)

**Conversion to Qdrant Filter**:
```python
def to_qdrant_filter(self) -> Optional[Filter]:
    if self.url:
        return Filter(
            must=[FieldCondition(key="url", match=MatchValue(value=self.url))]
        )
    if self.url_contains:
        return Filter(
            must=[FieldCondition(key="url", match=MatchText(text=self.url_contains))]
        )
    return None
```

---

### 4. DebugInfo

Diagnostic information for debug mode.

```python
@dataclass
class DebugInfo:
    query_embedding_dims: int      # Dimensions of query embedding
    query_embedding_time_ms: int   # Time to generate embedding
    collection_count: int          # Total vectors in collection
    search_time_ms: int            # Time for vector search
    score_min: float               # Minimum score in results
    score_max: float               # Maximum score in results
    score_avg: float               # Average score in results
```

**Source**: Computed during search execution when debug mode is enabled

---

## Data Flow

```
User Query (str)
    │
    ▼
┌─────────────────┐
│  SearchFilter   │  Parse CLI arguments
│ (url, top_k)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Query Vector   │  embed_query() - Cohere
│  (1024 floats)  │  input_type="search_query"
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Qdrant Search  │  search() with filter
│  (ScoredPoints) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  QueryResult[]  │  Convert payload to dataclass
│  (score, etc.)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ RetrievalResponse│  Package with metadata
│ (results, time) │
└─────────────────┘
```

---

## Qdrant Payload Schema

The existing payload structure from ingestion:

| Field | Type | Description |
|-------|------|-------------|
| content | string | Chunk text content |
| url | string | Source page URL |
| position | integer | Chunk position in document |
| created_at | float | Unix timestamp |

**Note**: The payload does not include `title` or `section` fields. These would need to be added to the ingestion pipeline if required.

---

## CLI Argument Mapping

| CLI Argument | Maps To | Type |
|--------------|---------|------|
| `query` (positional) | `search()` query param | str |
| `--top-k` | `SearchFilter.top_k` | int |
| `--url-filter` | `SearchFilter.url` | str |
| `--debug` | Enable `DebugInfo` collection | bool |
| `--json` | Output format flag | bool |
| `--collection` | Target collection name | str |

---

## Output Formats

### Text Output (Default)

```
Query: "What is ROS 2?"
Collection: rag_embedding
Results: 5 matches (420ms)

[1] Score: 0.89
    URL: https://ismailabdulkareem.github.io/AI_Book/docs/module-1/chapter-2
    Position: 2
    Content: ROS 2 (Robot Operating System 2) is a flexible framework for
             writing robot software. It provides tools, libraries, and
             conventions that aim to simplify the task of creating...

[2] Score: 0.84
    URL: https://ismailabdulkareem.github.io/AI_Book/docs/module-1/chapter-1
    Position: 0
    Content: Introduction to Physical AI and robotics fundamentals...
```

### JSON Output (--json flag)

```json
{
  "query": "What is ROS 2?",
  "collection": "rag_embedding",
  "results": [
    {
      "score": 0.89,
      "content": "ROS 2 (Robot Operating System 2) is a flexible framework...",
      "url": "https://ismailabdulkareem.github.io/AI_Book/docs/module-1/chapter-2",
      "position": 2,
      "created_at": 1734278400.0
    }
  ],
  "total": 5,
  "time_ms": 420
}
```

### Debug Output (--debug flag)

```
[DEBUG] Embedding query: "What is ROS 2?"
[DEBUG] Query vector: 1024 dimensions (152ms)
[DEBUG] Collection 'rag_embedding': 523 vectors
[DEBUG] Searching with top_k=5, filter=None
[DEBUG] Search completed in 268ms
[DEBUG] Score distribution: min=0.42, max=0.89, avg=0.68

Query: "What is ROS 2?"
... (normal output follows)
```
